version: '3.8'

# ==========================================
# NETWORKS
# ==========================================
networks:
  # External Traefik network (must exist: docker network create traefik-public)
  traefik-public:
    external: true

  # Internal network for backend services
  internal-net:
    driver: bridge

# ==========================================
# VOLUMES
# ==========================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  # Named volume for uploads (prevents shadowing)
  medusa_uploads:
    driver: local

# ==========================================
# SERVICES
# ==========================================
services:
  # ==========================================
  # POSTGRESQL DATABASE
  # ==========================================
  postgres:
    image: postgres:16-alpine
    container_name: samnghethaycu_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal-net

  # ==========================================
  # REDIS (CACHE & EVENT BUS)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: samnghethaycu_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal-net

  # ==========================================
  # MEDUSA SERVER (API + ADMIN)
  # WORKER_MODE=server
  # ==========================================
  medusa-server:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runner
    container_name: samnghethaycu_medusa_server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Core
      NODE_ENV: production
      MEDUSA_WORKER_MODE: server

      # Database & Cache
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_URL: redis://redis:6379

      # Secrets
      JWT_SECRET: ${JWT_SECRET}
      COOKIE_SECRET: ${COOKIE_SECRET}

      # Backend URL (for admin dashboard)
      MEDUSA_BACKEND_URL: https://api.samnghethaycu.com

      # CORS Configuration
      ADMIN_CORS: https://admin.samnghethaycu.com
      STORE_CORS: https://samnghethaycu.com,https://www.samnghethaycu.com
      AUTH_CORS: https://admin.samnghethaycu.com,https://samnghethaycu.com,https://www.samnghethaycu.com
    volumes:
      # CRITICAL: Only mount uploads directory (no source code!)
      # Path matches WORKDIR /app/server from Dockerfile
      - medusa_uploads:/app/server/uploads
    networks:
      - internal-net
      - traefik-public
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # ==========================================
      # API ROUTER (api.samnghethaycu.com)
      # ==========================================
      - "traefik.http.routers.medusa-api.rule=Host(`api.samnghethaycu.com`)"
      - "traefik.http.routers.medusa-api.entrypoints=websecure"
      - "traefik.http.routers.medusa-api.tls=true"
      - "traefik.http.routers.medusa-api.tls.certresolver=le"
      - "traefik.http.routers.medusa-api.service=medusa-api-service"
      - "traefik.http.services.medusa-api-service.loadbalancer.server.port=9000"

      # ==========================================
      # ADMIN REDIRECT MIDDLEWARE
      # Redirects admin.samnghethaycu.com/ â†’ admin.samnghethaycu.com/app
      # ==========================================
      - "traefik.http.middlewares.admin-redirect.redirectregex.regex=^https://admin\\.samnghethaycu\\.com/?$$"
      - "traefik.http.middlewares.admin-redirect.redirectregex.replacement=https://admin.samnghethaycu.com/app"
      - "traefik.http.middlewares.admin-redirect.redirectregex.permanent=true"

      # ==========================================
      # ADMIN ROUTER (admin.samnghethaycu.com)
      # ==========================================
      - "traefik.http.routers.medusa-admin.rule=Host(`admin.samnghethaycu.com`)"
      - "traefik.http.routers.medusa-admin.entrypoints=websecure"
      - "traefik.http.routers.medusa-admin.tls=true"
      - "traefik.http.routers.medusa-admin.tls.certresolver=le"
      - "traefik.http.routers.medusa-admin.middlewares=admin-redirect"
      - "traefik.http.routers.medusa-admin.service=medusa-admin-service"
      - "traefik.http.services.medusa-admin-service.loadbalancer.server.port=9000"

  # ==========================================
  # MEDUSA WORKER (BACKGROUND JOBS)
  # WORKER_MODE=worker
  # ==========================================
  medusa-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runner
    container_name: samnghethaycu_medusa_worker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Core
      NODE_ENV: production
      MEDUSA_WORKER_MODE: worker

      # Database & Cache
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_URL: redis://redis:6379

      # Secrets
      JWT_SECRET: ${JWT_SECRET}
      COOKIE_SECRET: ${COOKIE_SECRET}

      # Disable admin build for worker
      DISABLE_MEDUSA_ADMIN: "true"
    volumes:
      # Worker also needs uploads access (e.g., CSV imports, image processing)
      - medusa_uploads:/app/server/uploads
    networks:
      - internal-net

  # ==========================================
  # NEXT.JS STOREFRONT (OPTIONAL)
  # ==========================================
  storefront:
    build:
      context: ./storefront
      dockerfile: Dockerfile
    container_name: samnghethaycu_storefront
    restart: unless-stopped
    depends_on:
      - medusa-server
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_MEDUSA_BACKEND_URL: https://api.samnghethaycu.com
      NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: ${MEDUSA_PUBLISHABLE_KEY}
    networks:
      - traefik-public
      - internal-net
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # Storefront Router (samnghethaycu.com + www)
      - "traefik.http.routers.storefront.rule=Host(`samnghethaycu.com`) || Host(`www.samnghethaycu.com`)"
      - "traefik.http.routers.storefront.entrypoints=websecure"
      - "traefik.http.routers.storefront.tls=true"
      - "traefik.http.routers.storefront.tls.certresolver=le"
      - "traefik.http.services.storefront.loadbalancer.server.port=3000"

      # HTTP to HTTPS redirect
      - "traefik.http.middlewares.storefront-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.storefront-redirect.redirectscheme.permanent=true"
