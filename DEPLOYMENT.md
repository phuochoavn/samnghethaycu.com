# Multi-Tenant Deployment Guide

## Overview

This deployment has been architected for a **shared VPS environment** where multiple projects coexist with a common Traefik reverse proxy. All resources are namespaced to avoid conflicts.

## Architecture Changes from Standard Deployment

### 1. Namespace Isolation

All containers are prefixed with `sam_` to prevent naming conflicts:

| Original Name | Multi-Tenant Name |
|--------------|-------------------|
| `postgres` | `sam_postgres` |
| `redis` | `sam_redis` |
| `medusa-server` | `sam_medusa_server` |
| `medusa-worker` | `sam_medusa_worker` |

### 2. Traefik Integration

**REMOVED:** Standalone Traefik service (ports 80/443 already in use)

**ADDED:** Integration with existing Traefik instance via `traefik-public` network

**Key Configuration:**
- `sam_medusa_server` connects to **TWO networks**:
  - `sam_medusa_network` (internal) - for DB/Redis communication
  - `traefik-public` (external) - for Traefik ingress
- Traefik labels specify which network to use: `traefik.docker.network=traefik-public`

### 3. Namespaced Traefik Resources

All Traefik routers, services, and middlewares are prefixed with `sam-`:

| Resource Type | Name |
|--------------|------|
| Router (API) | `sam-api` |
| Router (Admin) | `sam-admin` |
| Service (API) | `sam-api` |
| Service (Admin) | `sam-admin` |
| Middleware | `sam-admin-redirect` |

This prevents conflicts with other projects sharing the same Traefik instance.

## Prerequisites

### On the VPS

1. **Existing Traefik network MUST exist:**
   ```bash
   docker network inspect traefik-public
   ```

   If it doesn't exist, create it:
   ```bash
   docker network create traefik-public
   ```

2. **Verify existing Traefik is configured for Docker provider:**
   ```bash
   docker inspect <traefik-container-id> | grep -A 10 "Cmd"
   ```

   Should include:
   - `--providers.docker=true`
   - `--providers.docker.exposedbydefault=false`

3. **DNS Configuration:**
   - `api.samnghethaycu.com` → VPS IP
   - `admin.samnghethaycu.com` → VPS IP

## Deployment Steps

### 1. Clone and Setup

```bash
cd /path/to/projects
git clone <repository-url> samnghethaycu
cd samnghethaycu
```

### 2. Configure Environment

```bash
cp .env.example .env
nano .env
```

**Required changes:**
```bash
# Security (GENERATE NEW SECRETS!)
JWT_SECRET=$(openssl rand -base64 32)
COOKIE_SECRET=$(openssl rand -base64 32)
```

**IMPORTANT:** Verify these are set correctly (should already be correct):
```bash
DATABASE_URL=postgresql://medusa:medusa@sam_postgres:5432/medusa_db
REDIS_URL=redis://sam_redis:6379
```

### 3. Build and Deploy

```bash
# Build images
docker compose build

# Start services
docker compose up -d

# Verify all services are running
docker compose ps
```

Expected output:
```
NAME                STATUS              PORTS
sam_postgres        Up (healthy)        5432/tcp
sam_redis           Up (healthy)        6379/tcp
sam_medusa_server   Up (healthy)        9000/tcp
sam_medusa_worker   Up                  9000/tcp
```

### 4. Verify Traefik Integration

```bash
# Check if Traefik detected the service
docker logs <traefik-container-id> 2>&1 | grep sam-

# Should see entries like:
# "Creating service sam-api"
# "Creating router sam-api"
# "Creating service sam-admin"
# "Creating router sam-admin"
# "Creating middleware sam-admin-redirect"
```

### 5. Test Endpoints

```bash
# Test API health
curl https://api.samnghethaycu.com/health

# Test admin redirect (should redirect to /app)
curl -I https://admin.samnghethaycu.com

# Access admin panel
# Browser: https://admin.samnghethaycu.com/app
```

## Verification Checklist

- [ ] All containers running with `sam_` prefix
- [ ] `sam_medusa_server` connected to both networks
- [ ] Traefik logs show service registration
- [ ] API endpoint responds: `https://api.samnghethaycu.com/health`
- [ ] Admin redirects correctly: `https://admin.samnghethaycu.com` → `/app`
- [ ] Admin panel accessible: `https://admin.samnghethaycu.com/app`
- [ ] SSL certificates auto-generated by Traefik
- [ ] No port conflicts (80/443)
- [ ] No container name conflicts

## Network Architecture

```
┌─────────────────────────────────────────┐
│       Existing Traefik Instance         │
│         (Container: 7d40400b690a)       │
│      Ports: 80 (HTTP), 443 (HTTPS)      │
└────────────────┬────────────────────────┘
                 │
                 │ traefik-public (external network)
                 │
     ┌───────────┴──────────────┐
     │   sam_medusa_server      │
     │   (Dual Network Mode)    │
     └───────────┬──────────────┘
                 │
                 │ sam_medusa_network (internal)
                 │
     ┌───────────┴────────────────────┐
     │                                │
┌────┴────────┐  ┌──────────────┐  ┌─┴───────────────┐
│ sam_postgres│  │  sam_redis   │  │ sam_medusa_worker│
└─────────────┘  └──────────────┘  └──────────────────┘
```

## Troubleshooting

### Issue: Container name conflicts

**Symptom:** `Error: The container name "/postgres" is already in use`

**Solution:** Verify all containers use `sam_` prefix in `docker-compose.yml`

### Issue: Traefik not routing traffic

**Symptom:** 404 Not Found or 502 Bad Gateway

**Check:**
1. Is `sam_medusa_server` connected to `traefik-public`?
   ```bash
   docker inspect sam_medusa_server | grep -A 20 Networks
   ```

2. Are Traefik labels applied?
   ```bash
   docker inspect sam_medusa_server | grep traefik.
   ```

3. Check Traefik logs:
   ```bash
   docker logs <traefik-container-id> --tail 100
   ```

### Issue: Database connection errors

**Symptom:** `Connection refused to postgres:5432`

**Solution:** Verify `DATABASE_URL` uses `sam_postgres`:
```bash
grep DATABASE_URL .env
# Should be: postgresql://medusa:medusa@sam_postgres:5432/medusa_db
```

### Issue: External network not found

**Symptom:** `network traefik-public declared as external, but could not be found`

**Solution:** Create the network:
```bash
docker network create traefik-public
```

Then ensure existing Traefik is connected:
```bash
docker network connect traefik-public <traefik-container-id>
```

## Maintenance

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f sam_medusa_server
```

### Restart Services

```bash
# All services
docker compose restart

# Specific service
docker compose restart sam_medusa_server
```

### Update Application

```bash
git pull origin main
docker compose build
docker compose up -d
```

### Database Migrations

Migrations run automatically on startup via `predeploy` script.

To run manually:
```bash
docker compose exec sam_medusa_server npm run db:migrate
```

## Cleanup (DANGER - Deletes Data)

```bash
# Stop all services
docker compose down

# Stop and remove volumes (deletes database and uploads!)
docker compose down -v
```

## Golden Architecture Compliance

✅ **Rule 1 (Missing Index.html Fix):** Dockerfile uses `WORKDIR /app/server`

✅ **Rule 2 (No Volume Shadowing):** Only `sam_medusa_uploads` mounted

✅ **Rule 3 (Routing & Admin Path):** Admin at `/app` with redirect middleware

✅ **Rule 4 (Split Architecture):** Redis modules + server/worker split

✅ **Rule 5 (Multi-Tenancy):** Namespaced containers, volumes, networks, and Traefik resources

## Security Notes

1. **Never expose PostgreSQL or Redis ports** - they are internal only
2. **Use strong secrets** - generate with `openssl rand -base64 32`
3. **Regular backups** - PostgreSQL data is in `sam_postgres_data` volume
4. **Monitor Traefik logs** - watch for unauthorized access attempts

## Support

For issues specific to:
- **Infrastructure:** Check this guide and `docker-compose.yml`
- **Medusa configuration:** See `backend/medusa-config.ts`
- **Application:** See main `README.md`
